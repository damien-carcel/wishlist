x-cache-env-variables: &cache-env-variables
  YARN_CACHE_FOLDER: /home/yarn-cache

x-database-env-variables: &database-env-variables
  DATABASE_URL: postgresql://root@database:26257/defaultdb?sslmode=disable

services:
  node:
    command:
      - sleep
      - infinity
    environment:
      <<: [*cache-env-variables, *database-env-variables]
      JEST_JUNIT_OUTPUT_DIR: ${JEST_JUNIT_OUTPUT_DIR:-}
      JEST_JUNIT_OUTPUT_NAME: ${JEST_JUNIT_OUTPUT_NAME:-result.xml}
    image: node:18
    user: 1000:1000
    volumes:
      - .:/srv/app
      - ${HOST_YARN_CACHE_FOLDER:-~/.cache/yarn}:/home/yarn-cache
      - ${HOST_YARN_CONFIG_FOLDER:-~/.config/yarn}:/.yarn
      - ${HOST_YARN_CONFIG_FILE:-~/.yarnrc}:/.yarnrc
    working_dir: /srv/app

  dev:
    command:
      - yarn
      - dev
    depends_on:
      - database
    environment:
      <<: *database-env-variables
    image: node:18
    ports:
      - 3000:3000
    user: 1000:1000
    volumes:
      - .:/srv/app
    working_dir: /srv/app

  prod:
    command:
      - yarn
      - start
    depends_on:
      - database
    environment:
      <<: *database-env-variables
    image: node:18
    ports:
      - 8000:3000
    user: 1000:1000
    volumes:
      - .:/srv/app
    working_dir: /srv/app

  database:
    command:
      - start-single-node
      - '--insecure'
      - '--store=type=mem,size=0.25'
      - '--advertise-addr=localhost'
    image: cockroachdb/cockroach
    ports:
      - 26257:26257
      - 8080:8080
