version: '3'

includes:
  database:
    internal: true
    taskfile: ./database.yaml
    vars:
      APP_ENV: test

tasks:
  code-style:check:
    aliases:
      - code-style:c
      - cs:check
      - cs:c
    cmds:
      - docker compose run --rm app vendor/bin/php-cs-fixer check {{.CLI_ARGS}}
    desc: Check the code-style

  code-style:fix:
    aliases:
      - code-style:f
      - cs:fix
      - cs:f
    cmds:
      - docker compose run --rm app vendor/bin/php-cs-fixer fix {{.CLI_ARGS}}
    desc: Fix the code-style

  static-analysis:
    aliases:
      - sa
    cmds:
      - docker compose run --rm app vendor/bin/phpstan analyse {{.CLI_ARGS}}
    desc: Run the static analysis

  unit:
    aliases:
      - u
    cmds:
      - docker compose run --rm app bin/phpunit --testsuite "Unit Tests" --testdox {{.CLI_ARGS}}
    desc: Run the unit tests

  acceptance:
    aliases:
      - a
    cmds:
      - docker compose run --rm app bin/phpunit --testsuite "Acceptance Tests" --testdox {{.CLI_ARGS}}
    desc: Run the acceptance tests

  integration-with-in-memory-adapters:
    aliases:
      - im
    cmds:
      - docker compose run --rm --env TEST_ENV="memory" app bin/phpunit --testsuite "Integration Tests" --group "with-in-memory-adapters" --testdox {{.CLI_ARGS}}
    desc: Run the integration tests for "in memory" adapters

  integration-with-production-adapters:
    aliases:
      - ip
    cmds:
      - docker compose run --rm --env TEST_ENV="test" app bin/phpunit --testsuite "Integration Tests" --group "with-production-adapters" --testdox {{.CLI_ARGS}}
    desc: Run the integration tests for "production" adapters

  integration:
    aliases:
      - i
    cmds:
      - task: integration-with-in-memory-adapters
      - task: integration-with-production-adapters
    desc: Run the integration tests for both "in memory" and "production" adapters

  end-to-end:
    aliases:
      - e
    cmds:
      - docker compose run --rm app bin/phpunit --testsuite "End-to-End Tests" --testdox {{.CLI_ARGS}}
    desc: Run the end-to-end tests

  setup-database:
    aliases:
      - db:setup
      - db:s
    cmds:
      - task: database:start
      - task: database:create:test-db
      - task: database:migrate
    desc: Set up the database for integration tests and end-to-end tests

  all:
    cmds:
      - echo ""
      - echo "|-----------------------|"
      - echo "|   Check code-style    |"
      - echo "|-----------------------|"
      - echo ""
      - task: code-style:check
      - echo ""
      - echo "|-----------------------|"
      - echo "|  Run static analysis  |"
      - echo "|-----------------------|"
      - echo ""
      - task: static-analysis
      - echo ""
      - echo "|-----------------------|"
      - echo "|    Run unit tests     |"
      - echo "|-----------------------|"
      - echo ""
      - task: unit
      - echo ""
      - echo "|-----------------------|"
      - echo "| Run acceptance tests  |"
      - echo "|-----------------------|"
      - echo ""
      - task: acceptance
      - echo ""
      - echo "|-----------------------|"
      - echo "| Run integration tests |"
      - echo "|-----------------------|"
      - echo ""
      - task: integration-with-in-memory-adapters
      - echo ""
      - task: setup-database
      - echo ""
      - task: integration-with-production-adapters
      - echo ""
      - echo "|-----------------------|"
      - echo "| Run end-to-end tests  |"
      - echo "|-----------------------|"
      - echo ""
      - task: end-to-end
      - echo ""
      - echo "|-----------------------|"
      - echo "|       All Tests       |"
      - echo "| Successfully Executed |"
      - echo "|-----------------------|"
      - echo ""
    desc: Execute all the tests
