version: '3'

tasks:
  database:
    desc: Start the database.
    cmds:
      - docker compose up -d database
    aliases: [db]

  wait-for-database:
    cmds:
      - |
        #!/usr/bin/env bash
        set -e
        COUNTER=1
        MAX_COUNTER=45
        echo "Waiting for CockroachDB…"
        until ${DOCKER_COMPOSE:-docker compose} exec database >&2 cockroach sql --insecure --execute="show tables"; do
          >&2 echo "CockroachDB is unavailable - sleeping"
          COUNTER=$((COUNTER + 1))
          if [ ${COUNTER} -gt ${MAX_COUNTER} ]; then
              echo "We have been waiting for CockroachDB too long already; failing." >&2
              exit 1
          fi;
          sleep 1
        done
        >&2 echo "CockroachDB is up - executing command"
        echo "CockroachDB is running!"
    internal: true

  create-migration:
    desc: "Create an SQL migration script. Use as follows: \"make create-migration -- 'my migration name'\"."
    cmds:
      - docker compose run --rm node yarn run migrate create {{.CLI_ARGS}}
    aliases: [cm]

  migrate:
    desc: Run the SQL migration scripts.
    cmds:
      - task: wait-for-database
      - docker compose run --rm node yarn run migrate up
    aliases: [m]

  build:
    desc: Build the production artifacts.
    cmds:
      - docker compose run --rm node yarn build
    aliases: [b]

  dev:
    desc: Run the application using the Vite development server.
    cmds:
      - task: database
      - task: migrate
      - docker compose up -d dev
      - echo ""
      - echo "┌───────────────────────────────────────────────────┐"
      - echo "│                                                   │"
      - echo "│   ◈ Server now ready on http://localhost:3000 ◈   │"
      - echo "│                                                   │"
      - echo "└───────────────────────────────────────────────────┘"
      - echo ""
    aliases: [d]

  prod:
    desc: Preview the production build. Be sure to first run "make install".
    cmds:
      - task: database
      - task: migrate
      - docker compose up -d prod
      - echo ""
      - echo "┌───────────────────────────────────────────────────┐"
      - echo "│                                                   │"
      - echo "│   ◈ Server now ready on http://localhost:8000 ◈   │"
      - echo "│                                                   │"
      - echo "└───────────────────────────────────────────────────┘"
      - echo ""
    aliases: [p]

  down:
    desc: Stop the application (dev or prod preview alike).
    cmds:
      - docker compose down -v --remove-orphans
    aliases: [dd]
